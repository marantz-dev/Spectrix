name: New Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., v1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Mark as pre-release"
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    steps:
      # 1. Checkout con Submodules
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. Configurazione CMake
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DJUCE_BUILD_EXTRAS=OFF \
            -DJUCE_BUILD_EXAMPLES=OFF

      # 3. Compilazione
      - name: Build
        run: cmake --build build --config Release --parallel

      # 4. Packaging con nome versione
      - name: Package Artifacts
        run: |
          mkdir -p dist
          OS_NAME="${{ matrix.os }}"
          # Nome file con versione e OS
          if [[ "$OS_NAME" == "macos-latest" ]]; then
          PLATFORM="macOS"
          find build -name "Spectrix.vst3" -type d -exec cp -R {} dist/ \;
          find build -name "Spectrix.component" -type d -exec cp -R {} dist/ \;
          cd dist
          cmake -E tar cfv ../Spectrix-${{ inputs.version }}-${PLATFORM}.zip --format=zip Spectrix.vst3 Spectrix.component
          else
          PLATFORM="Windows"
          find build -name "Spectrix.vst3" -type f -exec cp -R {} dist/ \;
          cd dist
          cmake -E tar cfv ../Spectrix-${{ inputs.version }}-${PLATFORM}.zip --format=zip Spectrix.vst3
          fi

      # 5. Upload artifact per la release
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Spectrix-${{ inputs.version }}-${{ matrix.os }}
          path: Spectrix-${{ inputs.version }}-*.zip

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 1. Download di tutti gli artifact
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # 2. Organizza i file per il rilascio
      - name: Prepare release assets
        run: |
          mkdir -p release-files
          find artifacts -name "*.zip" -exec cp {} release-files/ \;
          ls -lh release-files/

      # 3. Crea la release su GitHub
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: Spectrix ${{ inputs.version }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: release-files/*.zip
          body: |
            ## Spectrix ${{ inputs.version }}

            ### Download
            - **macOS**: `Spectrix-${{ inputs.version }}-macOS.zip`
            - **Windows**: `Spectrix-${{ inputs.version }}-Windows.zip`

            ### Installation
            1. Download the appropriate file for your OS
            2. Extract the ZIP archive
            3. Copy `Spectrix.vst3` to your VST3/AU folder:
               - **macOS** VST3: `/Library/Audio/Plug-Ins/VST3/`
               - **macOS** AU: `/Library/Audio/Plug-Ins/Components/`
               - **Windows** VST3: `C:\Program Files\Common Files\VST3\`

            ### Changes
            See below for auto-generated release notes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
